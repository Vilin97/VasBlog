<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/basic.css"> <link rel=icon  href="/assets/favicon.png"> <title>Tutorial on using spatial SSAs in DiffEqJump</title> <header> <div class=blog-name ><a href="">VasBlog</a></div> <nav> <ul> <li><a href="/">Home</a> <li><a href="/about/">About Me</a> <li><a href="/posts/">Blog</a> <li><a href="/menu3/">Test</a> </ul> <img src="/assets/hamburger.svg" id=menu-icon > </nav> </header> <div class=franklin-content > <h1 id=tutorial_on_using_spatial_ssas_in_diffeqjump ><a href="#tutorial_on_using_spatial_ssas_in_diffeqjump" class=header-anchor >Tutorial on using spatial SSAs in DiffEqJump</a></h1> <p>This blog will show how to use the functionality I added to <code>DiffEqJump</code> over the summer. See <a href="https://diffeq.sciml.ai/latest/types/jump_types/">the documentation</a> for a tutorial on getting started with <code>DiffEqJump</code>.</p> <h2 id=reversible_binding_model ><a href="#reversible_binding_model" class=header-anchor >Reversible binding model</a></h2> <p>A 5 by 5 Cartesian grid:</p> <table><tr><th align=right ><th align=right ><th align=right ><th align=right ><th align=right ><tr><td align=right >.<td align=right >.<td align=right >.<td align=right >.<td align=right >B<tr><td align=right >.<td align=right >.<td align=right >.<td align=right >.<td align=right >.<tr><td align=right >.<td align=right >.<td align=right >.<td align=right >.<td align=right >.<tr><td align=right >.<td align=right >.<td align=right >.<td align=right >.<td align=right >.<tr><td align=right >A<td align=right >.<td align=right >.<td align=right >.<td align=right >.</table> <p>Suppose we have a reversible binding system described by <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>+</mo><mi>B</mi><munderover><mo stretchy=true  minsize=3.0em >undefined</mo><mpadded width="+0.6em" lspace=0.3em ><msub><mi>k</mi><mn>2</mn></msub></mpadded><mpadded width="+0.6em" lspace=0.3em ><msub><mi>k</mi><mn>1</mn></msub></mpadded></munderover><mi>C</mi></mrow><annotation encoding="application/x-tex">A+B \xleftrightarrow[k_2]{k_1} C</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">A</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.816316em;vertical-align:-0.708208em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mrel x-arrow"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.108108em;"><span style="top:-3.322em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.03148em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span class=svg-align  style="top:-2.689em;"><span class=pstrut  style="height:2.7em;"></span><span class=stretchy  style="height:0.522em;min-width:1.75em;"><span class=halfarrow-left  style="height:0.522em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMinYMin slice'><path d='M400000 241H110l3-3c68.7-52.7 113.7-120 135-202 4-14.7 6-23 6-25 0-7.3-7-11-21-11-8 0-13.2.8-15.5 2.5-2.3 1.7-4.2 5.8 -5.5 12.5-1.3 4.7-2.7 10.3-4 17-12 48.7-34.8 92-68.5 130S65.3 228.3 18 247 c-10 4-16 7.7-18 11 0 8.7 6 14.3 18 17 47.3 18.7 87.8 47 121.5 85S196 441.3 208 490c.7 2 1.3 5 2 9s1.2 6.7 1.5 8c.3 1.3 1 3.3 2 6s2.2 4.5 3.5 5.5c1.3 1 3.3 1.8 6 2.5s6 1 10 1c14 0 21-3.7 21-11 0-2-2-10.3-6-25-20-79.3-65-146.7-135-202 l-3-3h399890zM100 241v40h399900v-40z'/></svg></span><span class=halfarrow-right  style="height:0.522em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399891c-47.3 35.3-84 78-110 128 -16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85 -40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5 -12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67 151.7 139 205zm0 0v40h399900v-40z'/></svg></span></span></span><span style="top:-2.091892em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight x-arrow-pad"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.03148em;margin-right:0.07142857142857144em;"><span class=pstrut  style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.708208em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, where <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">k_1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the forward rate and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">k_2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the backward rate. Further suppose that all <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> molecules start in the lower left corner, while all <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> molecules start in the upper right corner of a 5 by 5 grid. There are no <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> molecules at the start.</p> <p>We first create the grid:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> DiffEqJump
dims = (<span class=hljs-number >5</span>,<span class=hljs-number >5</span>)
grid = DiffEqJump.CartesianGridRej(dims) <span class=hljs-comment ># or use LightGraphs.grid(dims)</span></code></pre> <p>Now we set the initial state of the simulation. It has to be a matrix with entry <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mi>s</mi><mo separator=true >,</mo><mi>i</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(s,i)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal">s</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class=mclose >)</span></span></span></span> being the number of species <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> at site <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> &#40;with the standard column-major ordering of the grid&#41;.</p> <pre><code class="julia hljs">starting_state = zeros(<span class=hljs-built_in >Int</span>, <span class=hljs-number >3</span>, <span class=hljs-number >25</span>)
starting_state[<span class=hljs-number >1</span>,<span class=hljs-number >1</span>] = <span class=hljs-number >25</span>
starting_state[<span class=hljs-number >1</span>,<span class=hljs-number >2</span>] = <span class=hljs-number >25</span></code></pre> <p>We now set the time-span of the simulation and the reaction rates</p> <pre><code class="julia hljs">tspan = (<span class=hljs-number >0.0</span>, <span class=hljs-number >2.0</span>)
rates = [<span class=hljs-number >3.0</span>, <span class=hljs-number >0.05</span>] <span class=hljs-comment ># k_1 = rates[1], k_2 = rates[2]</span></code></pre> <p>Now we can create the <code>DiscreteProblem</code>:</p> <pre><code class="julia hljs">prob = DiscreteProblem(starting_state, tspan, rates)</code></pre>
<p>Since both reactions are <a href="https://en.wikipedia.org/wiki/Law_of_mass_action">massaction reactions</a>, we put them together in a <code>MassActionJump</code>. In order to do that we create two stoichiometry vectors. The net stoiciometry vector describes which molecules change in number and how much after each reaction; for example, <code>&#91;1 &#61;&gt; -1&#93;</code> is the first molecule disappearing. The reaction stoiciometry vector describes what the reactants of each reaction are; for example, <code>&#91;1 &#61;&gt; 1, 2 &#61;&gt; 1&#93;</code> would mean that the reactants are one molecule of type 1 and one molecule of type 2.</p>
<pre><code class="julia hljs">netstoch = [[<span class=hljs-number >1</span> =&gt; -<span class=hljs-number >1</span>, <span class=hljs-number >2</span> =&gt; -<span class=hljs-number >1</span>, <span class=hljs-number >3</span> =&gt; <span class=hljs-number >1</span>],[<span class=hljs-number >1</span> =&gt; <span class=hljs-number >1</span>, <span class=hljs-number >2</span> =&gt; <span class=hljs-number >1</span>, <span class=hljs-number >3</span> =&gt; -<span class=hljs-number >1</span>]]
reactstoch = [[<span class=hljs-number >1</span> =&gt; <span class=hljs-number >1</span>, <span class=hljs-number >2</span> =&gt; <span class=hljs-number >1</span>],[<span class=hljs-number >3</span> =&gt; <span class=hljs-number >1</span>]]
majumps = MassActionJump(rates, reactstoch, netstoch)</code></pre>
<p>The last thing to set up is the hopping constants – the probability per time of an andividual molecule of each species hopping from one site to another site. In practice this parameter, as well as reaction rates, are obtained empirically. Suppose that molecule <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> cannot diffuse, while molecules <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> diffuse at probability per time 1 &#40;i.e. the time of the diffusive hop is exponentially distributed with mean 1&#41;.</p>
<pre><code class="julia hljs">hopping_constants = ones(<span class=hljs-number >3</span>, <span class=hljs-number >25</span>)
hopping_constants[<span class=hljs-number >3</span>, :] = zeros(<span class=hljs-number >25</span>)</code></pre>
<p>We are now ready to set up the <code>JumpProblem</code> with the <a href="/posts/post2/#nsm">next subvolume method</a>. </p>
<pre><code class="julia hljs">alg = NSM() <span class=hljs-comment ># Next Subvolume Method. Can also use DirectCRonDirect</span>
jump_prob = JumpProblem(prob, alg, majumps, hopping_constants=hopping_constants, spatial_system = grid, save_positions=(<span class=hljs-literal >true</span>, <span class=hljs-literal >false</span>))</code></pre>
<p>The <code>save_positions</code> keyword tells the solver to save the positions just before the jumps. To solve the jump problem do</p>
<pre><code class="julia hljs">solution = solve(jump_prob, SSAStepper())</code></pre>
<p>Visualizing solutions of spatial jump problems is best done with animations. 
<figure>
  <img src="/assets/ABC_anim_275frames_5fps.gif" width="100%" />
</figure>
</p>
<p>This animation was produced by the following script.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots
is_static(spec) = (spec == <span class=hljs-number >3</span>) <span class=hljs-comment ># true if spec does not hop</span>
<span class=hljs-string >&quot;get frame k&quot;</span>
<span class=hljs-keyword >function</span> get_frame(k, sol, linear_size, labels, title)
    num_species = length(labels)
    h = <span class=hljs-number >1</span>/linear_size
    t = sol.t[k]
    state = sol.u[k]
    xlim=(<span class=hljs-number >0</span>,<span class=hljs-number >1</span>+<span class=hljs-number >3</span>h/<span class=hljs-number >2</span>); ylim=(<span class=hljs-number >0</span>,<span class=hljs-number >1</span>+<span class=hljs-number >3</span>h/<span class=hljs-number >2</span>);
    plt = plot(xlim=xlim, ylim=ylim, title = <span class=hljs-string >&quot;<span class=hljs-variable >$title</span>, <span class=hljs-subst >$(round(t, sigdigits=<span class=hljs-number >3</span>)</span>) seconds&quot;</span>)

    species_seriess_x = [[] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:num_species]
    species_seriess_y = [[] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:num_species]
    CI = <span class=hljs-built_in >CartesianIndices</span>((linear_size, linear_size))
    <span class=hljs-keyword >for</span> ci <span class=hljs-keyword >in</span> <span class=hljs-built_in >CartesianIndices</span>(state)
        species, site = <span class=hljs-built_in >Tuple</span>(ci)
        x,y = <span class=hljs-built_in >Tuple</span>(CI[site])
        num_molecules = state[ci]
        sizehint!(species_seriess_x[species], num_molecules)
        sizehint!(species_seriess_y[species], num_molecules)
        <span class=hljs-keyword >if</span> !is_static(species)
            randsx = rand(num_molecules)
            randsy = rand(num_molecules)
        <span class=hljs-keyword >else</span>
            randsx = zeros(num_molecules)
            randsy = zeros(num_molecules)
        <span class=hljs-keyword >end</span>
        <span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:num_molecules
            push!(species_seriess_x[species], x*h - h/<span class=hljs-number >2</span> + h*randsx[k])
            push!(species_seriess_y[species], y*h - h/<span class=hljs-number >2</span> + h*randsy[k])
        <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >for</span> species <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:num_species
        scatter!(plt, species_seriess_x[species], species_seriess_y[species], label = labels[species], marker = <span class=hljs-number >6</span>)
    <span class=hljs-keyword >end</span>
    xticks!(plt, range(xlim...,length = linear_size+<span class=hljs-number >1</span>))
    yticks!(plt, range(ylim...,length = linear_size+<span class=hljs-number >1</span>))
    xgrid!(plt, <span class=hljs-number >1</span>, <span class=hljs-number >0.7</span>)
    ygrid!(plt, <span class=hljs-number >1</span>, <span class=hljs-number >0.7</span>)
    <span class=hljs-keyword >return</span> plt
<span class=hljs-keyword >end</span>

<span class=hljs-string >&quot;make an animation of solution sol in 2 dimensions&quot;</span>
<span class=hljs-keyword >function</span> animate_2d(sol, linear_size; species_labels, title, verbose = <span class=hljs-literal >true</span>)
    num_frames = length(sol.t)
    anim = <span class=hljs-meta >@animate</span> <span class=hljs-keyword >for</span> k=<span class=hljs-number >1</span>:num_frames
        verbose &amp;&amp; println(<span class=hljs-string >&quot;Making frame <span class=hljs-variable >$k</span>&quot;</span>)
        get_frame(k, sol, linear_size, species_labels, title)
    <span class=hljs-keyword >end</span>
    anim
<span class=hljs-keyword >end</span>
<span class=hljs-comment ># animate</span>
anim=animate_2d(solution, <span class=hljs-number >5</span>, species_labels = [<span class=hljs-string >&quot;A&quot;</span>, <span class=hljs-string >&quot;B&quot;</span>, <span class=hljs-string >&quot;C&quot;</span>], title = <span class=hljs-string >&quot;A + B &lt;--&gt; C&quot;</span>, verbose = <span class=hljs-literal >false</span>)
fps = <span class=hljs-number >5</span>
name = <span class=hljs-string >&quot;ABC_anim_<span class=hljs-subst >$(length(solution.u)</span>)frames_<span class=hljs-subst >$(fps)</span>fps.gif&quot;</span>
path = joinpath(name)
gif(anim, path, fps = fps)</code></pre>
<div class=page-foot >
  <div class=copyright >
    &copy; Vasily Ilin. Last modified: August 02, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>